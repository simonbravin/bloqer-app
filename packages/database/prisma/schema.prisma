// ============================================================
// PRISMA SCHEMA - Bloqer SaaS
// Generated from ERD Mejorado (51 tablas)
// ============================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema", "fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations on Neon
  schemas  = ["public", "finance", "inventory", "quality"]
}

// ============================================================
// CORE: TENANCY & SECURITY
// ============================================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  taxId     String?  @map("tax_id")
  country   String?
  city      String?
  address   String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Super Admin: subscription & blocking
  subscriptionStatus   String    @default("TRIAL") @map("subscription_status") // TRIAL, ACTIVE, SUSPENDED, CANCELLED
  subscriptionPlan     String?   @map("subscription_plan") // FREE, BASIC, PRO, ENTERPRISE
  subscriptionStartDate DateTime? @map("subscription_start_date")
  subscriptionEndDate   DateTime? @map("subscription_end_date")
  maxProjects          Int       @default(3) @map("max_projects")
  maxUsers             Int       @default(5) @map("max_users")
  maxStorageGB         Int       @default(1) @map("max_storage_gb")
  isBlocked            Boolean   @default(false) @map("is_blocked")
  blockedReason        String?   @map("blocked_reason")
  blockedAt            DateTime? @map("blocked_at")
  blockedBy            String?   @map("blocked_by")
  enabledModules       Json?     @map("enabled_modules") // ["PROJECTS", "BUDGET", "SCHEDULE", ...]

  // Relations
  profile             OrgProfile?
  members             OrgMember[]
  projects            Project[]
  usageMetrics        OrgUsageMetrics[]
  parties             Party[]
  moduleActivations   ModuleActivation[]
  apiKeys             ApiKey[]
  idempotencyKeys     IdempotencyKey[]
  auditLogs           AuditLog[]
  customFieldDefs     CustomFieldDefinition[]
  workflowDefinitions WorkflowDefinition[]
  inventoryItems      InventoryItem[]
  inventoryLocations  InventoryLocation[]
  savedReports        SavedReport[]
  templates           Template[]
  exportRuns          ExportRun[]
  documents           Document[]
  financialTransactions FinanceTransaction[]
  commitments         Commitment[]
  certifications      Certification[]
  changeOrders        ChangeOrder[]
  rfis                RFI[]
  submittals          Submittal[]
  inspections         Inspection[]
  schedules           Schedule[]
  progressUpdates     ProgressUpdate[]
  dailyReports        DailyReport[]
  siteLogEntries      SiteLogEntry[]
  notifications       Notification[]
  webhookEndpoints    WebhookEndpoint[]
  outboxEvents        OutboxEvent[]
  orgPartyLinks       OrgPartyLink[]
  resources           Resource[]
  customReports       CustomReport[]
  invitations         Invitation[]
  bankAccounts        BankAccount[]

  @@index([slug])
  @@index([active])
  @@index([subscriptionStatus])
  @@index([isBlocked])
  @@map("organizations")
  @@schema("public")
}

model OrgProfile {
  id                  String   @id @default(uuid())
  orgId               String   @unique @map("org_id")
  legalName           String   @map("legal_name")
  taxId               String?  @map("tax_id")
  address             String?
  city                String?
  country             String?
  phone               String?
  email               String?
  website             String?
  baseCurrency        String   @default("USD") @map("base_currency")
  defaultTaxPct       Decimal  @default(0) @db.Decimal(5, 2) @map("default_tax_pct")
  defaultIndirectCostPct Decimal @default(0) @db.Decimal(5, 2) @map("default_indirect_cost_pct")
  logoStorageKey      String?  @map("logo_storage_key")
  documentFooterText  String?  @map("document_footer_text")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  currency     Currency     @relation(fields: [baseCurrency], references: [code])

  @@map("org_profiles")
  @@schema("public")
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  username           String?   @unique
  fullName           String    @map("full_name")
  passwordHash       String?   @map("password_hash")
  avatarUrl          String?   @map("avatar_url")
  active             Boolean   @default(true)
  isSuperAdmin       Boolean   @default(false) @map("is_super_admin")
  resetToken         String?   @map("reset_token")
  resetTokenExpires  DateTime? @map("reset_token_expires")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  lastLoginAt        DateTime? @map("last_login_at")

  // Relations
  memberships       OrgMember[]
  sessions          Session[]
  refreshTokens      RefreshToken[]
  idempotencyKeys   IdempotencyKey[]
  auditLogs           AuditLog[]
  notifications       Notification[]
  notificationsActed Notification[] @relation("NotificationActor")
  customReports       CustomReport[]
  invitationsSent   Invitation[]
  orgPreference     UserOrgPreference?

  @@index([email])
  @@index([active])
  @@index([isSuperAdmin])
  @@map("users")
  @@schema("public")
}

model UserOrgPreference {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  activeOrgId     String   @map("active_org_id")
  lastSwitchedAt DateTime @default(now()) @map("last_switched_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_org_preferences")
  @@schema("public")
}

model Invitation {
  id               String   @id @default(uuid())
  orgId            String   @map("org_id")
  email            String
  role             OrgRole
  token            String   @unique
  expiresAt        DateTime @map("expires_at")
  status           String   @default("PENDING") // PENDING|ACCEPTED|EXPIRED|REVOKED
  invitedByUserId  String   @map("invited_by_user_id")
  createdAt        DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@unique([orgId, email])
  @@index([orgId, status])
  @@index([token])
  @@map("invitations")
  @@schema("public")
}

enum OrgRole {
  OWNER
  ADMIN
  EDITOR
  ACCOUNTANT
  VIEWER

  @@schema("public")
}

model OrgMember {
  id                 String   @id @default(uuid())
  orgId              String   @map("org_id")
  userId             String   @map("user_id")
  role               OrgRole
  active             Boolean  @default(true)
  customPermissions  Json?    @map("custom_permissions") // { "finance": ["view","create"], "projects": ["view"] } - override del rol base
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectMembers     ProjectMember[]
  workflowApprovals  WorkflowApproval[]
  createdProjects    Project[]            @relation("ProjectCreatedBy")
  createdBudgets     BudgetVersion[]      @relation("BudgetCreatedBy")
  approvedBudgets    BudgetVersion[]      @relation("BudgetApprovedBy")
  createdTemplates   Template[]
  requestedExports   ExportRun[]
  requestedReports   SavedReportRun[]
  createdReports     SavedReport[]
  createdDocuments   Document[]
  uploadedDocVersions DocumentVersion[]
  createdSiteLogs    SiteLogEntry[]
  createdDailyReports DailyReport[]  @relation("DailyReportReportedBy")
  approvedDailyReports DailyReport[] @relation("DailyReportApprovedBy")
  createdPayments    Payment[]
  createdInventoryMovements InventoryMovement[]
  requestedChangeOrders ChangeOrder[]      @relation("ChangeOrderRequestedBy")
  approvedChangeOrders  ChangeOrder[]      @relation("ChangeOrderApprovedBy")
  changeOrderApprovals  ChangeOrderApproval[]
  raisedRFIs         RFI[]                @relation("RFIRaisedBy")
  assignedRFIs       RFI[]                @relation("RFIAssignedTo")
  createdRFIComments RFIComment[]
  reviewedSubmittals Submittal[]
  inspectorOf        Inspection[]
  createdProgressUpdates ProgressUpdate[]
  issuedCertifications Certification[]    @relation("CertificationIssuedBy")
  approvedCertifications Certification[]  @relation("CertificationApprovedBy")
  createdFinanceTx   FinanceTransaction[] @relation("FinanceTransactionCreatedBy")
  deletedFinanceTx   FinanceTransaction[] @relation("FinanceTransactionDeletedBy")
  createdCommitments Commitment[]         @relation("CommitmentCreatedBy")
  approvedCommitments Commitment[]        @relation("CommitmentApprovedBy")
  createdOrgPartyLinks OrgPartyLink[]
  schedulesCreated     Schedule[]  @relation("ScheduleCreatedBy")
  schedulesApproved    Schedule[]  @relation("ScheduleApprovedBy")

  @@unique([orgId, userId])
  @@index([userId])
  @@index([orgId, role])
  @@map("org_members")
  @@schema("public")
}

model Session {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @unique @map("token_hash")
  ipAddress String?   @map("ip_address")
  userAgent String?   @map("user_agent")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
  @@schema("public")
}

model ModuleActivation {
  id            String    @id @default(uuid())
  orgId         String    @map("org_id")
  module        String    // PROJECTS|BUDGET|FINANCE|etc
  active        Boolean   @default(true)
  activatedAt   DateTime  @default(now()) @map("activated_at")
  deactivatedAt DateTime? @map("deactivated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, module])
  @@index([orgId, active])
  @@map("module_activations")
  @@schema("public")
}

model ApiKey {
  id         String    @id @default(uuid())
  orgId      String    @map("org_id")
  name       String
  keyHash    String    @unique @map("key_hash")
  scopes     String[]  // Array of permissions
  createdAt  DateTime  @default(now()) @map("created_at")
  revokedAt  DateTime? @map("revoked_at")
  lastUsedAt DateTime? @map("last_used_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("api_keys")
  @@schema("public")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  tokenHash String    @unique @map("token_hash")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
  @@schema("public")
}

model IdempotencyKey {
  id           String    @id @default(uuid())
  orgId        String    @map("org_id")
  userId       String    @map("user_id")
  scope        String    // INVENTORY|PAYMENT|CERTIFICATION
  key          String    @unique
  requestHash  String    @map("request_hash")
  responseJson String?   @map("response_json") @db.Text
  status       String    // IN_PROGRESS|COMPLETED|FAILED
  createdAt    DateTime  @default(now()) @map("created_at")
  expiresAt    DateTime  @map("expires_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId, scope])
  @@index([expiresAt])
  @@map("idempotency_keys")
  @@schema("public")
}

model AuditLog {
  id              String   @id @default(uuid())
  orgId           String   @map("org_id")
  actorUserId     String   @map("actor_user_id")
  projectId       String?  @map("project_id")
  action          String   // CREATE|UPDATE|DELETE|APPROVE|REJECT|ISSUE
  entityType      String   @map("entity_type")
  entityId        String   @map("entity_id")
  requestId       String?  @map("request_id")
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  beforeSnapshot  Json?    @map("before_snapshot")
  afterSnapshot   Json?    @map("after_snapshot")
  detailsJson     Json?    @map("details_json")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  actor        User         @relation(fields: [actorUserId], references: [id])

  @@index([orgId, entityType, entityId])
  @@index([createdAt])
  @@index([actorUserId])
  @@map("audit_logs")
  @@schema("public")
}

// ============================================================
// SUPER ADMIN & USAGE METRICS
// ============================================================

model SuperAdminLog {
  id              String   @id @default(uuid())
  superAdminId    String   @map("super_admin_id")
  superAdminEmail String   @map("super_admin_email")
  action          String   // BLOCK_ORG, UNBLOCK_ORG, CHANGE_PLAN, IMPERSONATE, etc.
  targetType      String   @map("target_type") // ORGANIZATION, USER, SUBSCRIPTION
  targetId        String   @map("target_id")
  details         Json?
  ipAddress       String?  @map("ip_address")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([superAdminId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("super_admin_logs")
  @@schema("public")
}

model OrgUsageMetrics {
  id               String   @id @default(uuid())
  orgId            String   @map("org_id")
  month            Int
  year             Int
  activeUsers      Int      @default(0) @map("active_users")
  projectsCreated  Int      @default(0) @map("projects_created")
  storageUsedMB    Int       @default(0) @map("storage_used_mb")
  apiCalls         Int       @default(0) @map("api_calls")
  moduleUsage      Json?     @map("module_usage")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, month, year])
  @@index([orgId])
  @@map("org_usage_metrics")
  @@schema("public")
}

// ============================================================
// EXTENSIBILITY
// ============================================================

enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTI_SELECT
  CHECKBOX
  URL
  EMAIL
  PHONE

  @@schema("public")
}

model CustomFieldDefinition {
  id           String    @id @default(uuid())
  orgId        String    @map("org_id")
  entityType   String    @map("entity_type") // PROJECT|WBS_NODE|PARTY|etc
  fieldName    String    @map("field_name")
  fieldType    FieldType @map("field_type")
  options      Json?     // For SELECT types
  required     Boolean   @default(false)
  searchable   Boolean   @default(false)
  displayOrder Int       @default(0) @map("display_order")
  helpText     String?   @map("help_text")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  values       CustomFieldValue[]

  @@unique([orgId, entityType, fieldName])
  @@index([orgId, entityType])
  @@map("custom_field_definitions")
  @@schema("public")
}

model CustomFieldValue {
  id                  String   @id @default(uuid())
  orgId               String   @map("org_id")
  fieldDefinitionId   String   @map("field_definition_id")
  entityId            String   @map("entity_id")
  entityType          String   @map("entity_type")
  value               Json
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  fieldDefinition CustomFieldDefinition @relation(fields: [fieldDefinitionId], references: [id], onDelete: Cascade)

  @@unique([fieldDefinitionId, entityId])
  @@index([entityId, entityType])
  @@map("custom_field_values")
  @@schema("public")
}

// ============================================================
// WORKFLOW ENGINE
// ============================================================

model WorkflowDefinition {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  entityType  String   @map("entity_type") // BUDGET|CHANGE_ORDER|etc
  name        String
  description String?
  steps       Json     // Array of step definitions
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  instances    WorkflowInstance[]

  @@index([orgId, entityType, active])
  @@map("workflow_definitions")
  @@schema("public")
}

model WorkflowInstance {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  workflowDefinitionId String   @map("workflow_definition_id")
  entityType           String   @map("entity_type")
  entityId             String   @map("entity_id")
  status               String   // PENDING|IN_PROGRESS|APPROVED|REJECTED
  currentStep          Json     @map("current_step")
  createdAt            DateTime @default(now()) @map("created_at")
  completedAt          DateTime? @map("completed_at")

  // Relations
  workflowDefinition WorkflowDefinition @relation(fields: [workflowDefinitionId], references: [id])
  approvals          WorkflowApproval[]

  @@index([entityId, entityType])
  @@index([status])
  @@map("workflow_instances")
  @@schema("public")
}

model WorkflowApproval {
  id                 String   @id @default(uuid())
  orgId              String   @map("org_id")
  workflowInstanceId String   @map("workflow_instance_id")
  orgMemberId        String   @map("org_member_id")
  stepNumber         Int      @map("step_number")
  action             String   // APPROVED|REJECTED|DELEGATED
  comments           String?
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  workflowInstance WorkflowInstance @relation(fields: [workflowInstanceId], references: [id], onDelete: Cascade)
  approver         OrgMember        @relation(fields: [orgMemberId], references: [id])

  @@index([workflowInstanceId])
  @@map("workflow_approvals")
  @@schema("public")
}

// ============================================================
// PROJECTS
// ============================================================

enum ProjectPhase {
  PRE_CONSTRUCTION
  CONSTRUCTION
  CLOSEOUT
  COMPLETE

  @@schema("public")
}

model Project {
  id                   String       @id @default(uuid())
  orgId                String       @map("org_id")
  projectNumber        String       @map("project_number")
  name                 String
  description          String?
  clientName           String?      @map("client_name")
  location             String?
  m2                   Decimal?     @db.Decimal(15, 2)
  phase                ProjectPhase @default(PRE_CONSTRUCTION)
  status               String       @default("DRAFT")
  startDate            DateTime?    @map("start_date") @db.Date
  plannedEndDate       DateTime?    @map("planned_end_date") @db.Date
  actualEndDate        DateTime?    @map("actual_end_date") @db.Date
  customFields         Json         @default("{}") @map("custom_fields")
  totalBudget          Decimal?     @map("total_budget") @db.Decimal(15, 2)
  active               Boolean      @default(true)
  createdByOrgMemberId String       @map("created_by_org_member_id")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  // Relations
  organization       Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy          OrgMember             @relation("ProjectCreatedBy", fields: [createdByOrgMemberId], references: [id])
  members            ProjectMember[]
  wbsNodes           WbsNode[]
  budgetVersions     BudgetVersion[]
  changeOrders       ChangeOrder[]
  certifications     Certification[]
  financeTransactions FinanceTransaction[]
  commitments        Commitment[]
  rfis               RFI[]
  submittals         Submittal[]
  inspections        Inspection[]
  documents          Document[]
  schedules           Schedule[]
  progressUpdates    ProgressUpdate[]
  dailyReports       DailyReport[]
  siteLogEntries     SiteLogEntry[]
  inventoryLocations InventoryLocation[]
  inventoryMovements InventoryMovement[]
  exportRuns         ExportRun[]
  overheadAllocations OverheadAllocation[]
  alerts             Alert[]

  @@unique([orgId, projectNumber])
  @@index([orgId, status])
  @@index([orgId, phase])
  @@map("projects")
  @@schema("public")
}

model ProjectMember {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  orgMemberId String   @map("org_member_id")
  projectRole String   @map("project_role") // MANAGER|SUPERINTENDENT|VIEWER
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  orgMember OrgMember @relation(fields: [orgMemberId], references: [id], onDelete: Cascade)

  @@unique([projectId, orgMemberId])
  @@index([orgMemberId])
  @@map("project_members")
  @@schema("public")
}

// ============================================================
// WBS (Work Breakdown Structure)
// ============================================================

model WbsNode {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  projectId   String   @map("project_id")
  parentId    String?  @map("parent_id")
  code        String
  name        String
  category    String   // PHASE|ZONE|BUDGET_ITEM|TASK|MILESTONE
  description String?
  unit        String?
  quantity    Decimal? @db.Decimal(15, 4)
  metadata    Json     @default("{}")
  sortOrder   Int      @default(0) @map("sort_order")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Tier 2 - Progress tracking
  plannedHours      Decimal?  @map("planned_hours") @db.Decimal(15, 2)
  plannedCost        Decimal?  @map("planned_cost") @db.Decimal(15, 2)
  actualHours        Decimal   @default(0) @map("actual_hours") @db.Decimal(15, 2)
  actualCost         Decimal   @default(0) @map("actual_cost") @db.Decimal(15, 2)
  plannedStartDate   DateTime? @map("planned_start_date")
  plannedEndDate     DateTime? @map("planned_end_date")
  actualStartDate    DateTime? @map("actual_start_date")
  actualEndDate      DateTime? @map("actual_end_date")
  progressPct        Decimal   @default(0) @map("progress_pct") @db.Decimal(5, 2)
  healthStatus       String?   @map("health_status") // ON_TRACK|AT_RISK|DELAYED|AHEAD

  // Relations
  project              Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent               WbsNode?              @relation("WbsHierarchy", fields: [parentId], references: [id])
  children             WbsNode[]             @relation("WbsHierarchy")
  budgetLines          BudgetLine[]
  changeOrderLines     ChangeOrderLine[]
  certificationLines   CertificationLine[]
  financeLines         FinanceLine[]
  commitmentLines      CommitmentLine[]
  inventoryMovements   InventoryMovement[]
  rfis                 RFI[]
  submittals           Submittal[]
  inspections          Inspection[]
  scheduleTasks        ScheduleTask[]
  progressUpdates      ProgressUpdate[]
  dailyReports        DailyReport[]
  dailyReportWbsNodes  DailyReportWbsNode[]
  wbsProgressUpdates   WbsProgressUpdate[]

  @@unique([projectId, code])
  @@index([projectId, parentId])
  @@index([projectId, category])
  @@index([actualHours])
  @@index([progressPct])
  @@index([healthStatus])
  @@map("wbs_nodes")
  @@schema("public")
}

// ============================================================
// BUDGET + CHANGE ORDERS
// ============================================================

model BudgetVersion {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  projectId            String   @map("project_id")
  versionCode          String   @map("version_code")
  versionType          String   @default("BASELINE") @map("version_type")
  status               String   @default("DRAFT") // DRAFT, BASELINE, APPROVED
  notes                String?

  // Modo de markups: SIMPLE (globales) o ADVANCED (por línea)
  markupMode           String   @default("SIMPLE") @map("markup_mode") // SIMPLE, ADVANCED
  globalOverheadPct    Decimal  @default(10) @map("global_overhead_pct") @db.Decimal(5, 2)
  globalFinancialPct   Decimal  @default(5) @map("global_financial_pct") @db.Decimal(5, 2)
  globalProfitPct     Decimal  @default(20) @map("global_profit_pct") @db.Decimal(5, 2)
  globalTaxPct        Decimal  @default(21) @map("global_tax_pct") @db.Decimal(5, 2)

  createdByOrgMemberId String   @map("created_by_org_member_id")
  approvedByOrgMemberId String? @map("approved_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")
  approvedAt           DateTime? @map("approved_at")
  lockedAt             DateTime? @map("locked_at")

  // Relations
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy      OrgMember        @relation("BudgetCreatedBy", fields: [createdByOrgMemberId], references: [id])
  approvedBy     OrgMember?       @relation("BudgetApprovedBy", fields: [approvedByOrgMemberId], references: [id])
  budgetLines    BudgetLine[]
  changeOrders   ChangeOrder[]
  certifications Certification[]

  @@unique([projectId, versionCode])
  @@index([projectId, status])
  @@index([orgId])
  @@map("budget_versions")
  @@schema("public")
}

model BudgetLine {
  id               String  @id @default(uuid())
  orgId            String  @map("org_id")
  budgetVersionId  String  @map("budget_version_id")
  wbsNodeId        String  @map("wbs_node_id")
  resourceId       String? @map("resource_id")
  description      String
  unit             String
  quantity         Decimal @db.Decimal(15, 4)
  directCostTotal  Decimal @map("direct_cost_total") @db.Decimal(15, 2)
  importedDirectCostTotal Decimal? @map("imported_direct_cost_total") @db.Decimal(15, 2)
  salePriceTotal   Decimal @map("sale_price_total") @db.Decimal(15, 2)
  overheadPct      Decimal @default(0) @map("overhead_pct") @db.Decimal(5, 2)
  indirectCostPct  Decimal @default(0) @map("indirect_cost_pct") @db.Decimal(5, 2)
  financialPct     Decimal @default(0) @map("financial_pct") @db.Decimal(5, 2)
  profitPct        Decimal @default(0) @map("profit_pct") @db.Decimal(5, 2)
  taxPct           Decimal @default(0) @map("tax_pct") @db.Decimal(5, 2)
  retentionPct     Decimal @default(0) @map("retention_pct") @db.Decimal(5, 2)
  sortOrder        Int     @default(0) @map("sort_order")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  actualCostTotal   Decimal  @default(0) @map("actual_cost_total") @db.Decimal(15, 2)

  // Relations
  budgetVersion      BudgetVersion        @relation(fields: [budgetVersionId], references: [id], onDelete: Cascade)
  wbsNode            WbsNode              @relation(fields: [wbsNodeId], references: [id])
  resource           Resource?            @relation(fields: [resourceId], references: [id])
  resources          BudgetResource[]
  certificationLines CertificationLine[]
  dailyReports       DailyReport[]
  actualCosts        BudgetLineActualCost[]

  @@index([budgetVersionId])
  @@index([wbsNodeId])
  @@index([resourceId])
  @@index([actualCostTotal])
  @@map("budget_lines")
  @@schema("public")
}

model BudgetResource {
  id           String   @id @default(uuid())
  orgId        String   @map("org_id")
  budgetLineId String   @map("budget_line_id")
  resourceType String   @map("resource_type") // MATERIAL, LABOR, EQUIPMENT
  description  String
  unit         String
  quantity     Decimal  @db.Decimal(15, 4)
  unitCost     Decimal  @map("unit_cost") @db.Decimal(15, 2)
  totalCost    Decimal  @map("total_cost") @db.Decimal(15, 2)
  attributes   Json     @default("{}")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  budgetLine BudgetLine @relation(fields: [budgetLineId], references: [id], onDelete: Cascade)

  @@index([budgetLineId])
  @@map("budget_resources")
  @@schema("public")
}

model ChangeOrder {
  id                     String    @id @default(uuid())
  orgId                  String    @map("org_id")
  projectId              String    @map("project_id")
  budgetVersionId        String?   @map("budget_version_id")
  number                 Int
  title                  String
  status                 String    @default("DRAFT")
  changeType             String    @map("change_type")
  budgetImpactType       String    @default("DEVIATION") @map("budget_impact_type") // DEVIATION | APPROVED_CHANGE
  requestDate            DateTime  @default(now()) @map("request_date") @db.Date
  approvedDate           DateTime? @map("approved_date") @db.Date
  implementedDate        DateTime? @map("implemented_date") @db.Date
  reason                 String
  justification          String?
  costImpact             Decimal   @map("cost_impact") @db.Decimal(15, 2)
  timeImpactDays         Int       @default(0) @map("time_impact_days")
  requestedByOrgMemberId String    @map("requested_by_org_member_id")
  approvedByOrgMemberId  String?   @map("approved_by_org_member_id")
  partyId                String?   @map("party_id")
  rejectionReason        String?   @map("rejection_reason")
  feedbackRequested      String?   @map("feedback_requested")
  workflowInstanceId     String?   @map("workflow_instance_id")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  // Relations
  organization  Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project       Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  budgetVersion BudgetVersion?  @relation(fields: [budgetVersionId], references: [id])
  requestedBy   OrgMember       @relation("ChangeOrderRequestedBy", fields: [requestedByOrgMemberId], references: [id])
  approvedBy    OrgMember?      @relation("ChangeOrderApprovedBy", fields: [approvedByOrgMemberId], references: [id])
  party         Party?          @relation(fields: [partyId], references: [id])
  lines         ChangeOrderLine[]
  approvals     ChangeOrderApproval[]

  @@unique([projectId, number])
  @@index([projectId, status])
  @@index([projectId, budgetImpactType])
  @@map("change_orders")
  @@schema("public")
}

model ChangeOrderApproval {
  id             String   @id @default(uuid())
  changeOrderId  String   @map("change_order_id")
  orgMemberId   String   @map("org_member_id")
  decision      String   // APPROVED | REJECTED | CHANGES_REQUESTED
  comment       String?
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  changeOrder ChangeOrder @relation(fields: [changeOrderId], references: [id], onDelete: Cascade)
  orgMember   OrgMember   @relation(fields: [orgMemberId], references: [id], onDelete: Cascade)

  @@index([changeOrderId])
  @@map("change_order_approvals")
  @@schema("public")
}

model ChangeOrderLine {
  id               String   @id @default(uuid())
  orgId            String   @map("org_id")
  changeOrderId    String   @map("change_order_id")
  wbsNodeId        String   @map("wbs_node_id")
  changeType       String   @map("change_type") // ADD|MODIFY|DELETE
  originalQty      Decimal? @map("original_qty") @db.Decimal(15, 4)
  newQty           Decimal? @map("new_qty") @db.Decimal(15, 4)
  originalUnitCost Decimal? @map("original_unit_cost") @db.Decimal(15, 2)
  newUnitCost      Decimal? @map("new_unit_cost") @db.Decimal(15, 2)
  originalTotalCost Decimal? @map("original_total_cost") @db.Decimal(15, 2)
  newTotalCost     Decimal? @map("new_total_cost") @db.Decimal(15, 2)
  deltaCost        Decimal  @map("delta_cost") @db.Decimal(15, 2)
  justification    String
  sortOrder        Int      @default(0) @map("sort_order")

  // Relations
  changeOrder ChangeOrder @relation(fields: [changeOrderId], references: [id], onDelete: Cascade)
  wbsNode     WbsNode     @relation(fields: [wbsNodeId], references: [id])

  @@index([changeOrderId])
  @@map("change_order_lines")
  @@schema("public")
}

// ============================================================
// PARTIES (Suppliers/Clients)
// ============================================================

model Party {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  partyType   String   @map("party_type") // SUPPLIER|CLIENT|SUBCONTRACTOR
  name        String
  taxId       String?  @map("tax_id")
  email       String?
  phone       String?
  address     String?
  city        String?
  country     String?
  website     String?
  metadata    Json     @default("{}")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  organization        Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contacts            PartyContact[]
  financeTransactions FinanceTransaction[]
  commitments         Commitment[]
  submittals          Submittal[]
  suppliedResources   Resource[]
  changeOrders        ChangeOrder[]

  @@index([orgId, partyType])
  @@index([orgId, name])
  @@map("parties")
  @@schema("public")
}

// ============================================================
// RESOURCE CATALOG (org-wide)
// ============================================================

model Resource {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  code        String
  name        String
  category    String   // MATERIAL|LABOR|EQUIPMENT|SUBCONTRACT|OTHER
  description String?
  unit        String
  unitCost    Decimal  @map("unit_cost") @db.Decimal(15, 2)
  supplierId  String?  @map("supplier_id")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  supplier     Party?       @relation(fields: [supplierId], references: [id])
  budgetLines  BudgetLine[]

  @@unique([orgId, code])
  @@index([orgId, category])
  @@index([orgId, active])
  @@map("resources")
  @@schema("public")
}

model PartyContact {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  partyId   String   @map("party_id")
  fullName  String   @map("full_name")
  role      String?
  email     String?
  phone     String?
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([partyId])
  @@map("party_contacts")
  @@schema("public")
}

// ============================================================
// GLOBAL SUPPLIER DIRECTORY
// ============================================================

model GlobalParty {
  id                String   @id @default(uuid())
  name              String
  legalName         String?  @map("legal_name")
  taxId             String?  @map("tax_id")
  email             String?
  phone             String?
  website           String?
  logoUrl           String?  @map("logo_url")
  
  // Classification
  category          String   // CONCRETE_SUPPLIER|TOOL_MANUFACTURER|STEEL_SUPPLIER|etc
  subcategories     String[] // ["READY_MIX", "CEMENT"]
  
  // Verification
  verified          Boolean  @default(false)
  verifiedAt        DateTime? @map("verified_at")
  verifiedByStaff   String?  @map("verified_by_staff")
  
  // Coverage
  countries         String[] // ["US", "MX", "PE"]
  regions           String[] // ["California", "CDMX", "Lima"]
  
  // Description & Metadata
  description       String?  @db.Text
  certifications    Json     @default("[]") // ["ISO9001", "LEED", "OHSAS18001"]
  specialties       Json     @default("[]")
  metadata          Json     @default("{}")
  
  // Stats (computed/cached)
  avgRating         Decimal? @map("avg_rating") @db.Decimal(3, 2)
  reviewCount       Int      @default(0) @map("review_count")
  orgCount          Int      @default(0) @map("org_count")

  // Tier 2 - Supplier performance from daily reports
  lastUsedDate       DateTime? @map("last_used_date")
  totalSpentAllTime  Decimal   @default(0) @map("total_spent_all_time") @db.Decimal(15, 2)
  onTimePercentage   Decimal   @default(100) @map("on_time_percentage") @db.Decimal(5, 2)
  qualityScore       Decimal   @default(5) @map("quality_score") @db.Decimal(3, 2)
  
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  contacts          GlobalPartyContact[]
  orgLinks          OrgPartyLink[]
  products          GlobalProduct[]
  claims            GlobalPartyClaim[]
  reviews           GlobalPartyReview[]
  dailyReportInteractions DailyReportSupplier[]

  @@index([category])
  @@index([verified])
  @@index([name])
  @@index([lastUsedDate])
  @@index([onTimePercentage])
  @@map("global_parties")
  @@schema("public")
}

model GlobalPartyContact {
  id            String   @id @default(uuid())
  globalPartyId String   @map("global_party_id")
  fullName      String   @map("full_name")
  role          String?  // "Sales Manager", "Regional Director"
  email         String?
  phone         String?
  region        String?  // "North America", "LATAM"
  language      String?  // "es", "en", "pt"
  isPrimary     Boolean  @default(false) @map("is_primary")
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  globalParty GlobalParty @relation(fields: [globalPartyId], references: [id], onDelete: Cascade)

  @@index([globalPartyId])
  @@index([region])
  @@map("global_party_contacts")
  @@schema("public")
}

model OrgPartyLink {
  id                String   @id @default(uuid())
  orgId             String   @map("org_id")
  globalPartyId     String   @map("global_party_id")
  
  // Local Overrides
  localAlias        String?  @map("local_alias")
  localContactName  String?  @map("local_contact_name")
  localContactEmail String?  @map("local_contact_email")
  localContactPhone String?  @map("local_contact_phone")
  
  // Business Terms
  preferred         Boolean  @default(false)
  status            String   @default("ACTIVE") // ACTIVE|INACTIVE|BLOCKED
  paymentTerms      String?  @map("payment_terms") // "Net 30", "Net 60"
  discountPct       Decimal? @map("discount_pct") @db.Decimal(5, 2)
  creditLimit       Decimal? @map("credit_limit") @db.Decimal(15, 2)
  
  // Internal Reference
  notes             String?  @db.Text
  internalCode      String?  @map("internal_code")
  tags              String[] // ["preferido", "económico", "rápido"]
  
  // Stats (computed)
  totalOrders       Int      @default(0) @map("total_orders")
  totalSpent        Decimal  @default(0) @map("total_spent") @db.Decimal(15, 2)
  lastOrderDate     DateTime? @map("last_order_date")
  
  createdByOrgMemberId String @map("created_by_org_member_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  globalParty  GlobalParty  @relation(fields: [globalPartyId], references: [id])
  createdBy    OrgMember    @relation(fields: [createdByOrgMemberId], references: [id])

  @@unique([orgId, globalPartyId])
  @@index([orgId, preferred])
  @@index([orgId, status])
  @@map("org_party_links")
  @@schema("public")
}

model GlobalPartyClaim {
  id            String   @id @default(uuid())
  globalPartyId String   @map("global_party_id")
  
  // Claimant Information
  claimantName  String   @map("claimant_name")
  claimantEmail String   @map("claimant_email")
  claimantPhone String?  @map("claimant_phone")
  claimantRole  String   @map("claimant_role") // "Owner", "Marketing Manager"
  company       String?  // Company they claim to represent
  
  // Verification
  status        String   @default("PENDING") // PENDING|VERIFIED|REJECTED
  verificationToken String? @unique @map("verification_token")
  verificationDocs  String[] @map("verification_docs") // URLs to uploaded docs
  message       String?  @db.Text
  
  // Review by Staff
  reviewedBy    String?  @map("reviewed_by") // Staff user ID
  reviewedAt    DateTime? @map("reviewed_at")
  reviewNotes   String?  @map("review_notes") @db.Text
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  globalParty GlobalParty @relation(fields: [globalPartyId], references: [id], onDelete: Cascade)

  @@index([globalPartyId])
  @@index([status])
  @@index([claimantEmail])
  @@map("global_party_claims")
  @@schema("public")
}

model GlobalPartyReview {
  id            String   @id @default(uuid())
  globalPartyId String   @map("global_party_id")
  orgId         String   @map("org_id")
  orgMemberId   String   @map("org_member_id")
  
  // Overall Rating
  rating        Int      // 1-5 stars
  title         String?
  review        String?  @db.Text
  
  // Detailed Ratings (optional)
  qualityRating  Int?    @map("quality_rating")   // 1-5
  deliveryRating Int?    @map("delivery_rating")  // 1-5
  priceRating    Int?    @map("price_rating")     // 1-5
  serviceRating  Int?    @map("service_rating")   // 1-5
  
  // Verification
  verified      Boolean  @default(false)
  verifiedBy    String?  @map("verified_by") // Staff who verified
  orderIds      String[] @map("order_ids") // Related commitment/transaction IDs
  
  // Moderation
  status        String   @default("PUBLISHED") // PUBLISHED|FLAGGED|REMOVED
  flaggedReason String?  @map("flagged_reason")
  moderatedBy   String?  @map("moderated_by")
  moderatedAt   DateTime? @map("moderated_at")
  
  // Supplier Response
  supplierResponse String? @map("supplier_response") @db.Text
  respondedAt   DateTime? @map("responded_at")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  globalParty GlobalParty @relation(fields: [globalPartyId], references: [id], onDelete: Cascade)

  @@unique([globalPartyId, orgId])
  @@index([globalPartyId, status])
  @@index([rating])
  @@map("global_party_reviews")
  @@schema("public")
}

model GlobalProduct {
  id            String   @id @default(uuid())
  globalPartyId String   @map("global_party_id")
  
  // Product Info
  sku           String
  name          String
  description   String?  @db.Text
  category      String
  subcategory   String?
  unit          String   // "m3", "ton", "unit", "kg"
  
  // Reference Pricing
  referencePriceMin Decimal? @map("reference_price_min") @db.Decimal(15, 2)
  referencePriceMax Decimal? @map("reference_price_max") @db.Decimal(15, 2)
  currency      String   @default("USD")
  priceUpdatedAt DateTime? @map("price_updated_at")
  
  // Specifications
  specifications Json    @default("{}")
  certifications String[] // ["ISO9001", "CE", "UL"]
  technicalDocs  String[] @map("technical_docs") // URLs
  
  // Media
  imageUrl      String?  @map("image_url")
  images        String[] // Additional images
  datasheetUrl  String?  @map("datasheet_url")
  videoUrl      String?  @map("video_url")
  
  // Availability
  availability  String   @default("AVAILABLE") // AVAILABLE|OUT_OF_STOCK|DISCONTINUED
  leadTimeDays  Int?     @map("lead_time_days")
  minOrderQty   Decimal? @map("min_order_qty") @db.Decimal(15, 4)
  
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  globalParty GlobalParty @relation(fields: [globalPartyId], references: [id], onDelete: Cascade)

  @@unique([globalPartyId, sku])
  @@index([category])
  @@index([name])
  @@map("global_products")
  @@schema("public")
}

// ============================================================
// FINANCE (Multi-Currency)
// ============================================================

model Currency {
  code          String @id
  name          String
  symbol        String
  decimalPlaces Int    @default(2) @map("decimal_places")
  active        Boolean @default(true)

  // Relations
  orgProfiles          OrgProfile[]
  exchangeRatesFrom    ExchangeRate[]         @relation("ExchangeRateFrom")
  exchangeRatesTo      ExchangeRate[]         @relation("ExchangeRateTo")
  financeTransactions  FinanceTransaction[]
  commitments          Commitment[]

  @@map("currencies")
  @@schema("finance")
}

model ExchangeRate {
  id            String   @id @default(uuid())
  fromCurrency  String   @map("from_currency")
  toCurrency    String   @map("to_currency")
  rate          Decimal  @db.Decimal(15, 6)
  effectiveDate DateTime @map("effective_date") @db.Date
  source        String   @default("MANUAL")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  fromCurrencyRel Currency @relation("ExchangeRateFrom", fields: [fromCurrency], references: [code])
  toCurrencyRel   Currency @relation("ExchangeRateTo", fields: [toCurrency], references: [code])

  @@unique([fromCurrency, toCurrency, effectiveDate])
  @@index([effectiveDate])
  @@map("exchange_rates")
  @@schema("finance")
}

model FinanceTransaction {
  id                    String   @id @default(uuid())
  orgId                 String   @map("org_id")
  projectId             String?  @map("project_id")
  partyId               String?  @map("party_id")
  certificationId       String?  @map("certification_id")
  type                  String   // EXPENSE|INCOME|PURCHASE|SALE|OVERHEAD
  documentType          String   @default("INVOICE") @map("document_type") // INVOICE|RECEIPT|CREDIT_NOTE|DEBIT_NOTE
  status                String   @default("DRAFT")
  transactionNumber     String   @map("transaction_number")
  issueDate             DateTime @map("issue_date") @db.Date
  dueDate               DateTime? @map("due_date") @db.Date
  paidDate              DateTime? @map("paid_date") @db.Date
  currency              String   @default("USD")
  subtotal              Decimal  @db.Decimal(15, 2)
  taxTotal              Decimal  @default(0) @map("tax_total") @db.Decimal(15, 2)
  total                 Decimal  @db.Decimal(15, 2)
  amountBaseCurrency    Decimal  @map("amount_base_currency") @db.Decimal(15, 2)
  retentionAmount       Decimal  @default(0) @map("retention_amount") @db.Decimal(15, 2)
  adjustmentAmount      Decimal  @default(0) @map("adjustment_amount") @db.Decimal(15, 2)
  adjustmentNotes       String?  @map("adjustment_notes") @db.Text
  exchangeRateSnapshot  Json?    @map("exchange_rate_snapshot")
  description           String
  reference             String?
  deleted               Boolean  @default(false)
  deletedAt             DateTime? @map("deleted_at")
  deletedByOrgMemberId  String?  @map("deleted_by_org_member_id")
  createdByOrgMemberId  String   @map("created_by_org_member_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  dailyReportId         String?  @map("daily_report_id")

  // Relations
  organization         Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project              Project?             @relation(fields: [projectId], references: [id])
  party                Party?                @relation(fields: [partyId], references: [id])
  certification        Certification?        @relation(fields: [certificationId], references: [id])
  currencyRel          Currency             @relation(fields: [currency], references: [code])
  createdBy            OrgMember            @relation("FinanceTransactionCreatedBy", fields: [createdByOrgMemberId], references: [id])
  deletedBy            OrgMember?          @relation("FinanceTransactionDeletedBy", fields: [deletedByOrgMemberId], references: [id])
  dailyReport          DailyReport?        @relation(fields: [dailyReportId], references: [id])
  lines                FinanceLine[]
  payments             Payment[]
  overheadAllocations  OverheadAllocation[]
  inventoryMovements   InventoryMovement[]

  @@unique([orgId, transactionNumber])
  @@index([orgId, projectId])
  @@index([orgId, type, status])
  @@index([issueDate])
  @@index([dueDate])
  @@index([dailyReportId])
  @@index([certificationId])
  @@map("finance_transactions")
  @@schema("finance")
}

model FinanceLine {
  id            String  @id @default(uuid())
  orgId         String  @map("org_id")
  transactionId String  @map("transaction_id")
  wbsNodeId     String? @map("wbs_node_id")
  description   String
  unit          String?
  quantity      Decimal @db.Decimal(15, 4)
  unitPrice     Decimal @map("unit_price") @db.Decimal(15, 2)
  lineTotal     Decimal @map("line_total") @db.Decimal(15, 2)
  sortOrder     Int     @default(0) @map("sort_order")

  // Relations
  transaction FinanceTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  wbsNode     WbsNode?           @relation(fields: [wbsNodeId], references: [id])

  @@index([transactionId])
  @@map("finance_lines")
  @@schema("finance")
}

model Payment {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  transactionId        String   @map("transaction_id")
  bankAccountId        String?  @map("bank_account_id")
  paymentNumber        String   @map("payment_number")
  paidOn               DateTime @map("paid_on") @db.Date
  amount               Decimal  @db.Decimal(15, 2)
  method               String   @default("WIRE")
  reference            String?
  notes                String?
  createdByOrgMemberId String   @map("created_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  transaction   FinanceTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  bankAccount   BankAccount?       @relation(fields: [bankAccountId], references: [id])
  createdBy     OrgMember          @relation(fields: [createdByOrgMemberId], references: [id])

  @@index([transactionId])
  @@index([paidOn])
  @@index([bankAccountId])
  @@map("payments")
  @@schema("finance")
}

// For future bank reconciliation: link statements and payments to accounts
model BankAccount {
  id             String   @id @default(uuid())
  orgId          String   @map("org_id")
  name           String
  accountNumber  String?  @map("account_number")
  currencyCode   String   @default("USD") @map("currency_code")
  openingBalance Decimal  @default(0) @map("opening_balance") @db.Decimal(15, 2)
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  payments     Payment[]

  @@index([orgId])
  @@map("bank_accounts")
  @@schema("finance")
}

model OverheadAllocation {
  id               String   @id @default(uuid())
  orgId            String   @map("org_id")
  transactionId    String   @map("transaction_id")
  projectId        String   @map("project_id")
  allocationPct    Decimal  @map("allocation_pct") @db.Decimal(5, 2)
  allocationAmount Decimal  @map("allocation_amount") @db.Decimal(15, 2)
  notes            String?
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  transaction FinanceTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  project     Project            @relation(fields: [projectId], references: [id])

  @@index([transactionId])
  @@index([projectId])
  @@map("overhead_allocations")
  @@schema("finance")
}

// ============================================================
// COMMITMENTS (PO/Contracts)
// ============================================================

model Commitment {
  id                    String   @id @default(uuid())
  orgId                 String   @map("org_id")
  projectId             String   @map("project_id")
  partyId               String   @map("party_id")
  commitmentType        String   @map("commitment_type") // PO|CONTRACT|SUBCONTRACT
  commitmentNumber      String   @map("commitment_number")
  status                String   @default("DRAFT")
  issueDate             DateTime @map("issue_date") @db.Date
  startDate             DateTime? @map("start_date") @db.Date
  endDate               DateTime? @map("end_date") @db.Date
  reference             String?
  description           String?
  total                 Decimal  @db.Decimal(15, 2)
  currency              String   @default("USD")
  totalBaseCurrency     Decimal  @map("total_base_currency") @db.Decimal(15, 2)
  deleted               Boolean  @default(false)
  createdByOrgMemberId  String   @map("created_by_org_member_id")
  approvedByOrgMemberId String?  @map("approved_by_org_member_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  party        Party              @relation(fields: [partyId], references: [id])
  currencyRel  Currency           @relation(fields: [currency], references: [code])
  createdBy    OrgMember          @relation("CommitmentCreatedBy", fields: [createdByOrgMemberId], references: [id])
  approvedBy   OrgMember?         @relation("CommitmentApprovedBy", fields: [approvedByOrgMemberId], references: [id])
  lines        CommitmentLine[]

  @@unique([orgId, commitmentNumber])
  @@index([projectId, status])
  @@map("commitments")
  @@schema("public")
}

model CommitmentLine {
  id           String  @id @default(uuid())
  orgId        String  @map("org_id")
  commitmentId String  @map("commitment_id")
  wbsNodeId    String? @map("wbs_node_id")
  description  String
  unit         String?
  quantity     Decimal @db.Decimal(15, 4)
  unitPrice    Decimal @map("unit_price") @db.Decimal(15, 2)
  lineTotal    Decimal @map("line_total") @db.Decimal(15, 2)
  sortOrder    Int     @default(0) @map("sort_order")

  // Relations
  commitment Commitment @relation(fields: [commitmentId], references: [id], onDelete: Cascade)
  wbsNode    WbsNode?   @relation(fields: [wbsNodeId], references: [id])

  @@index([commitmentId])
  @@map("commitment_lines")
  @@schema("public")
}

// ============================================================
// CERTIFICATIONS (Immutable)
// ============================================================

model Certification {
  id                    String   @id @default(uuid())
  orgId                 String   @map("org_id")
  projectId             String   @map("project_id")
  budgetVersionId       String   @map("budget_version_id")
  number                Int
  periodMonth           Int      @map("period_month")
  periodYear            Int      @map("period_year")
  issuedDate            DateTime? @map("issued_date") @db.Date
  status                String   @default("DRAFT")
  notes                 String?
  integritySeal         String?  @map("integrity_seal")
  issuedByOrgMemberId   String?  @map("issued_by_org_member_id")
  approvedByOrgMemberId String?  @map("approved_by_org_member_id")
  createdAt             DateTime @default(now()) @map("created_at")
  issuedAt              DateTime? @map("issued_at")
  approvedAt            DateTime? @map("approved_at")

  // Relations
  organization  Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project       Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  budgetVersion BudgetVersion       @relation(fields: [budgetVersionId], references: [id])
  issuedBy      OrgMember?          @relation("CertificationIssuedBy", fields: [issuedByOrgMemberId], references: [id])
  approvedBy    OrgMember?          @relation("CertificationApprovedBy", fields: [approvedByOrgMemberId], references: [id])
  lines         CertificationLine[]
  financeTransactions FinanceTransaction[]

  @@unique([projectId, number])
  @@index([projectId, status])
  @@map("certifications")
  @@schema("public")
}

model CertificationLine {
  id                      String   @id @default(uuid())
  orgId                   String   @map("org_id")
  certificationId         String   @map("certification_id")
  wbsNodeId               String   @map("wbs_node_id")
  budgetLineId            String   @map("budget_line_id")
  prevProgressPct         Decimal  @default(0) @map("prev_progress_pct") @db.Decimal(5, 2)
  periodProgressPct       Decimal  @map("period_progress_pct") @db.Decimal(5, 2)
  totalProgressPct        Decimal  @map("total_progress_pct") @db.Decimal(5, 2)
  contractualQtySnapshot  Decimal  @map("contractual_qty_snapshot") @db.Decimal(15, 4)
  unitPriceSnapshot       Decimal  @map("unit_price_snapshot") @db.Decimal(15, 2)
  prevQty                 Decimal  @default(0) @map("prev_qty") @db.Decimal(15, 4)
  periodQty               Decimal  @map("period_qty") @db.Decimal(15, 4)
  totalQty                Decimal  @map("total_qty") @db.Decimal(15, 4)
  remainingQty            Decimal  @map("remaining_qty") @db.Decimal(15, 4)
  prevAmount              Decimal  @default(0) @map("prev_amount") @db.Decimal(15, 2)
  periodAmount            Decimal  @map("period_amount") @db.Decimal(15, 2)
  totalAmount             Decimal  @map("total_amount") @db.Decimal(15, 2)
  createdAt               DateTime @default(now()) @map("created_at")

  // Relations
  certification Certification @relation(fields: [certificationId], references: [id], onDelete: Cascade)
  wbsNode       WbsNode       @relation(fields: [wbsNodeId], references: [id])
  budgetLine    BudgetLine    @relation(fields: [budgetLineId], references: [id])

  @@index([certificationId])
  @@map("certification_lines")
  @@schema("public")
}

// ============================================================
// INVENTORY (Ledger-based)
// ============================================================

model InventoryCategory {
  id        String   @id @default(uuid())
  name      String
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  subcategories InventorySubcategory[]
  items         InventoryItem[]         @relation("ItemCategory")

  @@map("inventory_categories")
  @@schema("inventory")
}

model InventorySubcategory {
  id         String   @id @default(uuid())
  categoryId String   @map("category_id")
  name       String
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  category InventoryCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  items    InventoryItem[]

  @@index([categoryId])
  @@map("inventory_subcategories")
  @@schema("inventory")
}

model InventoryItem {
  id             String   @id @default(uuid())
  orgId          String   @map("org_id")
  sku            String
  name           String
  description    String?
  categoryId     String   @map("category_id")
  subcategoryId  String?  @map("subcategory_id")
  unit           String
  minStockQty    Decimal? @map("min_stock_qty") @db.Decimal(15, 4)
  reorderQty     Decimal? @map("reorder_qty") @db.Decimal(15, 4)
  metadata       Json     @default("{}")
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  category     InventoryCategory     @relation("ItemCategory", fields: [categoryId], references: [id])
  subcategory  InventorySubcategory? @relation(fields: [subcategoryId], references: [id])
  movements    InventoryMovement[]
  consumptions InventoryConsumption[]

  @@unique([orgId, sku])
  @@index([orgId, categoryId])
  @@map("inventory_items")
  @@schema("inventory")
}

model InventoryLocation {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  type      String   // CENTRAL_WAREHOUSE|PROJECT_SITE|SUPPLIER
  projectId String?  @map("project_id")
  name      String
  address   String?
  metadata  Json     @default("{}")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization   Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project        Project?            @relation(fields: [projectId], references: [id])
  movementsFrom  InventoryMovement[] @relation("MovementFrom")
  movementsTo    InventoryMovement[] @relation("MovementTo")

  @@index([orgId, type])
  @@index([projectId])
  @@map("inventory_locations")
  @@schema("inventory")
}

model InventoryMovement {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  itemId               String   @map("item_id")
  movementType         String   @map("movement_type") // PURCHASE|TRANSFER|ISSUE|ADJUSTMENT
  fromLocationId       String?  @map("from_location_id")
  toLocationId         String?  @map("to_location_id")
  projectId            String?  @map("project_id")
  wbsNodeId            String?  @map("wbs_node_id")
  transactionId        String?  @map("transaction_id")
  quantity             Decimal  @db.Decimal(15, 4)
  unitCost             Decimal  @map("unit_cost") @db.Decimal(15, 2)
  totalCost            Decimal  @map("total_cost") @db.Decimal(15, 2)
  notes                String?
  idempotencyKey       String   @unique @map("idempotency_key")
  createdByOrgMemberId String   @map("created_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")
  dailyReportId        String?  @map("daily_report_id")

  // Relations
  item         InventoryItem       @relation(fields: [itemId], references: [id])
  fromLocation InventoryLocation?  @relation("MovementFrom", fields: [fromLocationId], references: [id])
  toLocation   InventoryLocation?  @relation("MovementTo", fields: [toLocationId], references: [id])
  project      Project?            @relation(fields: [projectId], references: [id])
  wbsNode      WbsNode?            @relation(fields: [wbsNodeId], references: [id])
  transaction  FinanceTransaction? @relation(fields: [transactionId], references: [id])
  dailyReport  DailyReport?        @relation(fields: [dailyReportId], references: [id])
  createdBy    OrgMember           @relation(fields: [createdByOrgMemberId], references: [id])

  @@index([itemId, toLocationId])
  @@index([projectId])
  @@index([createdAt])
  @@index([dailyReportId])
  @@map("inventory_movements")
  @@schema("inventory")
}

// ============================================================
// QUALITY MANAGEMENT
// ============================================================

model RFI {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  projectId            String   @map("project_id")
  number                Int
  status               String   @default("OPEN")
  priority             String   @default("MEDIUM")
  wbsNodeId            String?  @map("wbs_node_id")
  raisedByOrgMemberId  String   @map("raised_by_org_member_id")
  assignedToOrgMemberId String? @map("assigned_to_org_member_id")
  subject              String
  question             String
  answer               String?
  dueDate              DateTime? @map("due_date") @db.Date
  answeredDate         DateTime? @map("answered_date") @db.Date
  closedDate           DateTime? @map("closed_date") @db.Date
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  wbsNode      WbsNode?     @relation(fields: [wbsNodeId], references: [id])
  raisedBy     OrgMember    @relation("RFIRaisedBy", fields: [raisedByOrgMemberId], references: [id])
  assignedTo   OrgMember?   @relation("RFIAssignedTo", fields: [assignedToOrgMemberId], references: [id])
  comments     RFIComment[]

  @@unique([projectId, number])
  @@index([projectId, status])
  @@map("rfis")
  @@schema("quality")
}

model RFIComment {
  id          String   @id @default(uuid())
  orgId       String   @map("org_id")
  rfiId       String   @map("rfi_id")
  orgMemberId String   @map("org_member_id")
  comment     String
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rfi    RFI       @relation(fields: [rfiId], references: [id], onDelete: Cascade)
  author OrgMember @relation(fields: [orgMemberId], references: [id])

  @@index([rfiId])
  @@map("rfi_comments")
  @@schema("quality")
}

model Submittal {
  id                    String   @id @default(uuid())
  orgId                 String   @map("org_id")
  projectId             String   @map("project_id")
  wbsNodeId             String?  @map("wbs_node_id")
  number                Int
  submittalType         String   @map("submittal_type")
  status                String   @default("DRAFT")
  specSection           String?  @map("spec_section")
  submittedByPartyId    String?  @map("submitted_by_party_id")
  reviewedByOrgMemberId String?  @map("reviewed_by_org_member_id")
  submittedDate         DateTime? @map("submitted_date") @db.Date
  dueDate               DateTime @map("due_date") @db.Date
  reviewedDate          DateTime? @map("reviewed_date") @db.Date
  reviewComments        String?  @map("review_comments")
  revisionNumber        Int      @default(0) @map("revision_number")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  wbsNode      WbsNode?     @relation(fields: [wbsNodeId], references: [id])
  submittedBy  Party?       @relation(fields: [submittedByPartyId], references: [id])
  reviewedBy   OrgMember?   @relation(fields: [reviewedByOrgMemberId], references: [id])

  @@unique([projectId, number])
  @@index([projectId, status])
  @@map("submittals")
  @@schema("quality")
}

model Inspection {
  id                    String   @id @default(uuid())
  orgId                 String   @map("org_id")
  projectId             String   @map("project_id")
  wbsNodeId             String?  @map("wbs_node_id")
  number                Int
  inspectionType        String   @map("inspection_type")
  status                String   @default("SCHEDULED")
  scheduledDate          DateTime? @map("scheduled_date") @db.Date
  completedDate         DateTime? @map("completed_date") @db.Date
  inspectorOrgMemberId  String?  @map("inspector_org_member_id")
  findings              String?
  correctiveActions     String?  @map("corrective_actions")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  wbsNode      WbsNode?          @relation(fields: [wbsNodeId], references: [id])
  inspector    OrgMember?        @relation(fields: [inspectorOrgMemberId], references: [id])
  items        InspectionItem[]

  @@unique([projectId, number])
  @@index([projectId, status])
  @@map("inspections")
  @@schema("quality")
}

model InspectionItem {
  id              String @id @default(uuid())
  orgId           String @map("org_id")
  inspectionId    String @map("inspection_id")
  itemDescription String @map("item_description")
  status          String // PASS|FAIL|NA
  notes           String?
  sortOrder       Int    @default(0) @map("sort_order")

  // Relations
  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@map("inspection_items")
  @@schema("quality")
}

// ============================================================
// DOCUMENTS (Versioned)
// ============================================================

model Document {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  projectId            String?  @map("project_id")
  title                String
  docType              String   @map("doc_type")
  category             String?
  description          String?
  isPublic             Boolean  @default(false) @map("is_public")
  deleted              Boolean  @default(false)
  createdByOrgMemberId String   @map("created_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project         Project?          @relation(fields: [projectId], references: [id])
  createdBy       OrgMember         @relation(fields: [createdByOrgMemberId], references: [id])
  versions        DocumentVersion[]
  links           DocumentLink[]
  dailyReportPhotos DailyReportPhoto[]

  @@index([orgId, projectId])
  @@index([orgId, docType])
  @@map("documents")
  @@schema("public")
}

model DocumentVersion {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  documentId           String   @map("document_id")
  versionNumber        Int      @map("version_number")
  fileName             String   @map("file_name")
  mimeType             String   @map("mime_type")
  sizeBytes            Int      @map("size_bytes")
  storageKey           String   @map("storage_key")
  checksum             String
  notes                String?
  uploadedByOrgMemberId String  @map("uploaded_by_org_member_id")
  uploadedAt           DateTime @default(now()) @map("uploaded_at")

  // Relations
  document   Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy OrgMember @relation(fields: [uploadedByOrgMemberId], references: [id])

  @@index([documentId])
  @@map("document_versions")
  @@schema("public")
}

model DocumentLink {
  id         String   @id @default(uuid())
  orgId      String   @map("org_id")
  documentId String   @map("document_id")
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([entityType, entityId])
  @@map("document_links")
  @@schema("public")
}

// ============================================================
// TEMPLATES & EXPORTS
// ============================================================

model Template {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  templateType         String   @map("template_type")
  name                 String
  version              Int      @default(1)
  active               Boolean  @default(true)
  storageKey           String   @map("storage_key")
  variables            Json?
  notes                String?
  createdByOrgMemberId String   @map("created_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy    OrgMember    @relation(fields: [createdByOrgMemberId], references: [id])

  @@index([orgId, templateType])
  @@map("templates")
  @@schema("public")
}

model ExportRun {
  id                     String   @id @default(uuid())
  orgId                  String   @map("org_id")
  projectId              String?  @map("project_id")
  requestedByOrgMemberId  String   @map("requested_by_org_member_id")
  exportType             String   @map("export_type")
  format                 String
  status                 String   @default("QUEUED")
  fileStorageKey         String?  @map("file_storage_key")
  paramsJson             Json?    @map("params_json")
  errorMessage           String?  @map("error_message")
  createdAt              DateTime @default(now()) @map("created_at")
  completedAt            DateTime? @map("completed_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id])
  requestedBy  OrgMember    @relation(fields: [requestedByOrgMemberId], references: [id])

  @@index([orgId, status])
  @@index([createdAt])
  @@map("export_runs")
  @@schema("public")
}

// ============================================================
// REPORTING
// ============================================================

model SavedReport {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  name                 String
  description          String?
  entityType           String   @map("entity_type")
  filtersJson          Json     @map("filters_json")
  columnsJson          Json     @map("columns_json")
  sortJson             Json?    @map("sort_json")
  aggregationsJson     Json?    @map("aggregations_json")
  visibility           String   @default("PRIVATE")
  createdByOrgMemberId String   @map("created_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy    OrgMember        @relation(fields: [createdByOrgMemberId], references: [id])
  runs         SavedReportRun[]

  @@index([orgId, entityType])
  @@map("saved_reports")
  @@schema("public")
}

model SavedReportRun {
  id                     String   @id @default(uuid())
  orgId                  String   @map("org_id")
  reportId               String   @map("report_id")
  requestedByOrgMemberId String   @map("requested_by_org_member_id")
  format                 String
  status                 String   @default("QUEUED")
  fileStorageKey         String?  @map("file_storage_key")
  paramsOverride         Json?    @map("params_override")
  createdAt              DateTime @default(now()) @map("created_at")
  completedAt            DateTime? @map("completed_at")

  // Relations
  report      SavedReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  requestedBy OrgMember   @relation(fields: [requestedByOrgMemberId], references: [id])

  @@index([reportId])
  @@map("saved_report_runs")
  @@schema("public")
}

// ============================================================
// REPORTING & EXPORTS (Custom Reports)
// ============================================================

model CustomReport {
  id              String    @id @default(uuid())
  orgId           String    @map("org_id")
  name            String
  description     String?   @db.Text
  category        String    // "BUDGET", "MATERIALS", "FINANCE", "CERTIFICATIONS", "CUSTOM"
  reportType      String    @map("report_type") // "TABLE", "SUMMARY", "PIVOT"

  // Configuración JSON
  config          Json      // { query, filters, columns, groupBy, orderBy }

  // Metadata
  isPublic        Boolean   @default(false) @map("is_public")
  createdByUserId String    @map("created_by_user_id")
  lastRunAt       DateTime? @map("last_run_at")
  runCount        Int       @default(0) @map("run_count")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy     User        @relation(fields: [createdByUserId], references: [id])

  @@index([orgId])
  @@index([createdByUserId])
  @@index([category])
  @@map("custom_reports")
  @@schema("public")
}

// ============================================================
// SCHEDULE / GANTT
// ============================================================

model Schedule {
  id                   String    @id @default(uuid())
  orgId                String    @map("org_id")
  projectId            String    @map("project_id")

  name                 String    // "Cronograma Inicial", "Rev 1", etc.
  description          String?   @db.Text
  status               String    @default("DRAFT") // DRAFT, BASELINE, APPROVED

  projectStartDate     DateTime  @map("project_start_date")
  projectEndDate       DateTime  @map("project_end_date")

  workingDaysPerWeek   Int       @default(6) @map("working_days_per_week")
  hoursPerDay          Int       @default(8) @map("hours_per_day")

  isBaseline           Boolean   @default(false) @map("is_baseline")
  baselineDate         DateTime? @map("baseline_date")

  createdByOrgMemberId String    @map("created_by_org_member_id")
  approvedByOrgMemberId String?  @map("approved_by_org_member_id")
  approvedAt           DateTime? @map("approved_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  organization         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project              Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy            OrgMember    @relation("ScheduleCreatedBy", fields: [createdByOrgMemberId], references: [id])
  approvedBy           OrgMember?   @relation("ScheduleApprovedBy", fields: [approvedByOrgMemberId], references: [id])
  tasks                ScheduleTask[]
  dependencies         TaskDependency[]

  @@index([orgId])
  @@index([projectId])
  @@index([status])
  @@map("schedules")
  @@schema("public")
}

model ScheduleTask {
  id                 String    @id @default(uuid())
  scheduleId         String    @map("schedule_id")
  wbsNodeId          String    @map("wbs_node_id")

  taskType           String    @default("TASK") // TASK, MILESTONE, SUMMARY

  plannedStartDate   DateTime  @map("planned_start_date")
  plannedEndDate     DateTime  @map("planned_end_date")
  plannedDuration    Int       @map("planned_duration")

  actualStartDate    DateTime? @map("actual_start_date")
  actualEndDate      DateTime? @map("actual_end_date")
  actualDuration     Int?      @map("actual_duration")

  progressPercent    Decimal   @default(0) @db.Decimal(5, 2) @map("progress_percent")

  earlyStart         DateTime? @map("early_start")
  earlyFinish        DateTime? @map("early_finish")
  lateStart          DateTime? @map("late_start")
  lateFinish         DateTime? @map("late_finish")
  totalFloat         Int?      @map("total_float")
  freeFloat          Int?      @map("free_float")
  isCritical         Boolean   @default(false) @map("is_critical")

  constraintType     String?   @map("constraint_type")
  constraintDate     DateTime? @map("constraint_date")

  assignedTo         String?   @map("assigned_to")
  notes              String?   @db.Text

  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  schedule           Schedule   @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  wbsNode            WbsNode    @relation(fields: [wbsNodeId], references: [id], onDelete: Cascade)
  successors         TaskDependency[] @relation("PredecessorTask")
  predecessors      TaskDependency[] @relation("SuccessorTask")
  progressUpdates    ProgressUpdate[]

  @@index([scheduleId])
  @@index([wbsNodeId])
  @@index([isCritical])
  @@map("schedule_tasks")
  @@schema("public")
}

model TaskDependency {
  id              String   @id @default(uuid())
  scheduleId      String   @map("schedule_id")
  predecessorId   String   @map("predecessor_id")
  successorId     String   @map("successor_id")

  dependencyType  String   @default("FS") @map("dependency_type") // FS, SS, FF, SF
  lagDays         Int      @default(0) @map("lag_days")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  schedule        Schedule      @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  predecessor     ScheduleTask  @relation("PredecessorTask", fields: [predecessorId], references: [id], onDelete: Cascade)
  successor       ScheduleTask  @relation("SuccessorTask", fields: [successorId], references: [id], onDelete: Cascade)

  @@unique([predecessorId, successorId])
  @@index([scheduleId])
  @@index([predecessorId])
  @@index([successorId])
  @@map("task_dependencies")
  @@schema("public")
}

// ============================================================
// PROGRESS UPDATES
// ============================================================

model ProgressUpdate {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  projectId            String   @map("project_id")
  wbsNodeId            String?  @map("wbs_node_id")
  scheduleTaskId       String?  @map("schedule_task_id")
  asOfDate             DateTime @map("as_of_date") @db.Date
  progressPct          Decimal  @map("progress_pct") @db.Decimal(5, 2)
  notes                String?
  createdByOrgMemberId String   @map("created_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  wbsNode      WbsNode?      @relation(fields: [wbsNodeId], references: [id])
  scheduleTask ScheduleTask? @relation(fields: [scheduleTaskId], references: [id])
  createdBy    OrgMember     @relation(fields: [createdByOrgMemberId], references: [id])

  @@index([projectId, asOfDate])
  @@map("progress_updates")
  @@schema("public")
}

// ============================================================
// DAILY REPORTS (Enhanced)
// ============================================================

model DailyReport {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  projectId            String   @map("project_id")
  reportDate           DateTime @map("report_date") @db.Date
  summary              String   @db.VarChar(200)
  workAccomplished     String?  @map("work_accomplished") @db.Text
  observations         String?  @db.Text
  weather              String?
  temperatureHigh      Decimal? @map("temperature_high") @db.Decimal(5, 2)
  temperatureLow       Decimal? @map("temperature_low") @db.Decimal(5, 2)
  delays               String?  @db.Text
  safetyIncidents      String?  @map("safety_incidents") @db.Text
  visitors             String?  @db.Text
  deliveries           String?  @db.Text
  laborCountTotal      Int?     @map("labor_count_total")
  equipmentCountTotal  Int?     @map("equipment_count_total")
  status               String   @default("DRAFT") // DRAFT|SUBMITTED|APPROVED|PUBLISHED
  submittedAt          DateTime? @map("submitted_at")
  approvedByOrgMemberId String?  @map("approved_by_org_member_id")
  approvedAt          DateTime? @map("approved_at")
  wbsNodeId            String?  @map("wbs_node_id")
  createdByOrgMemberId String   @map("created_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Tier 2 - Budget & costs (optional, default 0)
  budgetLineId         String?  @map("budget_line_id")
  laborCosts           Decimal  @default(0) @map("labor_costs") @db.Decimal(15, 2)
  materialCosts        Decimal  @default(0) @map("material_costs") @db.Decimal(15, 2)
  otherCosts           Decimal  @default(0) @map("other_costs") @db.Decimal(15, 2)
  totalCost            Decimal  @default(0) @map("total_cost") @db.Decimal(15, 2)

  // Relations
  organization Organization           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy    OrgMember              @relation("DailyReportReportedBy", fields: [createdByOrgMemberId], references: [id])
  approvedBy   OrgMember?             @relation("DailyReportApprovedBy", fields: [approvedByOrgMemberId], references: [id])
  wbsNode      WbsNode?               @relation(fields: [wbsNodeId], references: [id])
  budgetLine   BudgetLine?            @relation(fields: [budgetLineId], references: [id])
  labor        DailyReportLabor[]
  equipment    DailyReportEquipment[]
  photos       DailyReportPhoto[]
  wbsNodes     DailyReportWbsNode[]
  inventoryConsumptions InventoryConsumption[]
  supplierInteractions  DailyReportSupplier[]
  progressUpdates       WbsProgressUpdate[]
  budgetLineActualCosts BudgetLineActualCost[]
  inventoryMovements    InventoryMovement[]
  financialTransactions FinanceTransaction[]
  alerts                Alert[]

  @@index([projectId])
  @@index([projectId, reportDate])
  @@index([status])
  @@index([budgetLineId])
  @@map("daily_reports")
  @@schema("public")
}

model DailyReportWbsNode {
  id            String      @id @default(uuid())
  dailyReportId String      @map("daily_report_id")
  wbsNodeId     String      @map("wbs_node_id")
  dailyReport   DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  wbsNode       WbsNode     @relation(fields: [wbsNodeId], references: [id], onDelete: Cascade)
  @@unique([dailyReportId, wbsNodeId])
  @@index([dailyReportId])
  @@index([wbsNodeId])
  @@map("daily_report_wbs_nodes")
  @@schema("public")
}

model DailyReportLabor {
  id            String  @id @default(uuid())
  orgId         String  @map("org_id")
  dailyReportId String  @map("daily_report_id")
  trade         String
  workerCount   Int     @map("worker_count")
  hoursWorked   Decimal @map("hours_worked") @db.Decimal(10, 2)
  notes         String?

  // Relations
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)

  @@index([dailyReportId])
  @@map("daily_report_labor")
  @@schema("public")
}

model DailyReportEquipment {
  id            String  @id @default(uuid())
  orgId         String  @map("org_id")
  dailyReportId String  @map("daily_report_id")
  equipmentType String  @map("equipment_type")
  quantity      Int
  hoursUsed     Decimal @map("hours_used") @db.Decimal(10, 2)
  notes         String?

  // Relations
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)

  @@index([dailyReportId])
  @@map("daily_report_equipment")
  @@schema("public")
}

model DailyReportPhoto {
  id            String @id @default(uuid())
  orgId         String @map("org_id")
  dailyReportId String @map("daily_report_id")
  documentId    String @map("document_id")
  caption       String?
  sortOrder     Int    @default(0) @map("sort_order")

  // Relations
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  document    Document    @relation(fields: [documentId], references: [id])

  @@index([dailyReportId])
  @@map("daily_report_photos")
  @@schema("public")
}

// Tier 2 - Inventory consumptions linked to daily report
model InventoryConsumption {
  id                String   @id @default(uuid())
  dailyReportId     String   @map("daily_report_id")
  inventoryItemId   String   @map("inventory_item_id")
  quantity          Decimal  @db.Decimal(15, 4)
  unit              String
  costPerUnit       Decimal? @map("cost_per_unit") @db.Decimal(15, 2)
  totalCost         Decimal? @map("total_cost") @db.Decimal(15, 2)
  movementId        String?  @map("movement_id")
  metadata          Json     @default("{}")
  createdAt         DateTime @default(now()) @map("created_at")

  dailyReport     DailyReport     @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem   @relation(fields: [inventoryItemId], references: [id])

  @@index([dailyReportId])
  @@index([inventoryItemId])
  @@map("inventory_consumptions")
  @@schema("public")
}

// Tier 2 - Supplier interactions per daily report
model DailyReportSupplier {
  id              String   @id @default(uuid())
  dailyReportId   String   @map("daily_report_id")
  globalPartyId   String   @map("global_party_id")
  type            String   // PURCHASE|DELIVERY|ISSUE|COMMUNICATION|VISIT
  amount          Decimal? @db.Decimal(15, 2)
  currency        String   @default("USD")
  quantity        Decimal? @db.Decimal(15, 4)
  quantityUnit    String?  @map("quantity_unit")
  deliveryStatus  String?  @map("delivery_status") // ON_TIME|LATE|PARTIAL|FULL
  daysLate        Int?     @map("days_late")
  invoiceNumber   String?  @map("invoice_number")
  invoiceUrl      String?  @map("invoice_url")
  description     String?  @db.Text
  quality         String?  // PERFECT|GOOD|ACCEPTABLE|POOR|REJECTED
  issues          String?  @db.Text
  commitmentId    String?  @map("commitment_id")
  paymentId       String?  @map("payment_id")
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")

  dailyReport   DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  globalParty   GlobalParty @relation(fields: [globalPartyId], references: [id])

  @@index([dailyReportId])
  @@index([globalPartyId])
  @@index([type])
  @@map("daily_report_suppliers")
  @@schema("public")
}

// Tier 2 - WBS progress updates from daily reports
model WbsProgressUpdate {
  id              String   @id @default(uuid())
  wbsNodeId       String   @map("wbs_node_id")
  dailyReportId   String   @map("daily_report_id")
  hoursAdded      Decimal  @map("hours_added") @db.Decimal(15, 2)
  costAdded       Decimal? @map("cost_added") @db.Decimal(15, 2)
  progressBefore  Decimal  @map("progress_before") @db.Decimal(5, 2)
  progressAfter   Decimal  @map("progress_after") @db.Decimal(5, 2)
  status          String   // ON_TRACK|AT_RISK|DELAYED|AHEAD
  variance        Decimal? @db.Decimal(5, 2)
  notes           String?  @db.Text
  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")

  wbsNode     WbsNode     @relation(fields: [wbsNodeId], references: [id])
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id])

  @@index([wbsNodeId])
  @@index([dailyReportId])
  @@index([status])
  @@map("wbs_progress_updates")
  @@schema("public")
}

// Tier 2 - Actual costs per budget line per daily report
model BudgetLineActualCost {
  id              String   @id @default(uuid())
  budgetLineId    String   @map("budget_line_id")
  dailyReportId   String   @map("daily_report_id")
  laborCost       Decimal  @default(0) @map("labor_cost") @db.Decimal(15, 2)
  materialCost    Decimal  @default(0) @map("material_cost") @db.Decimal(15, 2)
  equipmentCost   Decimal  @default(0) @map("equipment_cost") @db.Decimal(15, 2)
  subcontractCost Decimal @default(0) @map("subcontract_cost") @db.Decimal(15, 2)
  otherCost       Decimal  @default(0) @map("other_cost") @db.Decimal(15, 2)
  totalCost       Decimal  @map("total_cost") @db.Decimal(15, 2)
  budgetedCost    Decimal? @map("budgeted_cost") @db.Decimal(15, 2)
  variance        Decimal? @db.Decimal(5, 2)
  date            DateTime @default(now())
  metadata        Json     @default("{}")

  budgetLine   BudgetLine   @relation(fields: [budgetLineId], references: [id])
  dailyReport DailyReport   @relation(fields: [dailyReportId], references: [id])

  @@unique([budgetLineId, dailyReportId])
  @@index([budgetLineId])
  @@index([date])
  @@map("budget_line_actual_costs")
  @@schema("public")
}

// Tier 2 - Alerts generated from daily report approval (WBS delayed, budget over, etc.)
model Alert {
  id                String    @id @default(uuid())
  projectId         String    @map("project_id")
  dailyReportId     String?   @map("daily_report_id")
  type              String    // WBS_DELAYED|BUDGET_OVER|BUDGET_CRITICAL|CASHFLOW_RISK
  severity          String    // INFO|WARNING|CRITICAL
  title             String
  description       String    @db.Text
  affectedEntityId  String?   @map("affected_entity_id")   // wbsNodeId or budgetLineId
  affectedEntityType String?  @map("affected_entity_type") // WBS|BUDGET
  metadata          Json?     @default("{}")               // e.g. { variance: 15.5, budgeted: 5000, actual: 5775 }
  resolved          Boolean   @default(false)
  resolvedAt        DateTime? @map("resolved_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dailyReport DailyReport? @relation(fields: [dailyReportId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([dailyReportId])
  @@index([type])
  @@index([resolved])
  @@map("alerts")
  @@schema("public")
}

// Legacy Site Log (can be deprecated later)
model SiteLogEntry {
  id                   String   @id @default(uuid())
  orgId                String   @map("org_id")
  projectId            String   @map("project_id")
  logDate              DateTime @map("log_date") @db.Date
  title                String
  description          String?
  weather              String?
  createdByOrgMemberId String   @map("created_by_org_member_id")
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy    OrgMember    @relation(fields: [createdByOrgMemberId], references: [id])

  @@index([projectId, logDate])
  @@map("site_log_entries")
  @@schema("public")
}

// ============================================================
// EVENTS & WEBHOOKS
// ============================================================

model OutboxEvent {
  id           String    @id @default(uuid())
  orgId        String?   @map("org_id")
  eventType    String    @map("event_type")
  payload      Json
  status       String    @default("PENDING")
  retryCount   Int       @default(0) @map("retry_count")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")
  processedAt  DateTime? @map("processed_at")
  nextRetryAt  DateTime? @map("next_retry_at")

  // Relations
  organization      Organization?       @relation(fields: [orgId], references: [id])
  webhookDeliveries WebhookDelivery[]

  @@index([status, createdAt])
  @@index([nextRetryAt])
  @@map("outbox_events")
  @@schema("public")
}

model WebhookEndpoint {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  url       String
  events    String[] // Array of event types
  secret    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization      Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  webhookDeliveries WebhookDelivery[]

  @@index([orgId, active])
  @@map("webhook_endpoints")
  @@schema("public")
}

model WebhookDelivery {
  id                String   @id @default(uuid())
  webhookEndpointId String   @map("webhook_endpoint_id")
  outboxEventId     String   @map("outbox_event_id")
  attemptNumber     Int      @map("attempt_number")
  httpStatus        Int?     @map("http_status")
  responseBody      String?  @map("response_body")
  deliveredAt       DateTime @default(now()) @map("delivered_at")

  // Relations
  webhookEndpoint WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)
  outboxEvent     OutboxEvent     @relation(fields: [outboxEventId], references: [id])

  @@index([webhookEndpointId])
  @@index([outboxEventId])
  @@map("webhook_deliveries")
  @@schema("public")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id           String    @id @default(uuid())
  orgId        String    @map("org_id")
  userId       String    @map("user_id")
  actorUserId  String?   @map("actor_user_id") // who triggered the action (e.g. approver); null = system
  type         String    // EMAIL|IN_APP|SMS
  category     String    // LOW_STOCK|APPROVAL_REQUEST|CERTIFICATION_ISSUED|etc
  title        String
  message      String
  metadata     Json?
  read         Boolean   @default(false)
  readAt       DateTime? @map("read_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  actor        User?        @relation("NotificationActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
  @@schema("public")
}

// ============================================================
// PROJECT TEMPLATES & CONSTRUCTION SYSTEMS
// ============================================================

model ProjectTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  category    String // "RESIDENTIAL", "COMMERCIAL", "PUBLIC"
  active      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  wbsTemplates WbsTemplate[]

  @@map("project_templates")
  @@schema("public")
}

model ConstructionSystem {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  category    String // "STRUCTURE", "ROOF", "WALLS"
  active      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  wbsTemplates WbsTemplate[]

  @@map("construction_systems")
  @@schema("public")
}

model WbsTemplate {
  id                    String   @id @default(uuid())
  projectTemplateId     String   @map("project_template_id")
  parentId              String?  @map("parent_id")
  code                  String
  name                  String
  category              String // "PHASE", "TASK", "SUBTASK", "ITEM"
  unit                  String?
  defaultQuantity       Decimal? @db.Decimal(15, 4) @map("default_quantity")

  // Filtros
  constructionSystemId  String?  @map("construction_system_id")

  // Metadata
  description String? @db.Text
  notes       String? @db.Text
  sortOrder   Int     @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  projectTemplate   ProjectTemplate   @relation(fields: [projectTemplateId], references: [id], onDelete: Cascade)
  parent            WbsTemplate?      @relation("WbsTemplateHierarchy", fields: [parentId], references: [id])
  children          WbsTemplate[]     @relation("WbsTemplateHierarchy")
  constructionSystem ConstructionSystem? @relation(fields: [constructionSystemId], references: [id])
  resourceTemplates BudgetResourceTemplate[]

  @@index([projectTemplateId])
  @@index([parentId])
  @@index([constructionSystemId])
  @@index([code])
  @@map("wbs_templates")
  @@schema("public")
}

model BudgetResourceTemplate {
  id             String   @id @default(uuid())
  wbsTemplateId  String   @map("wbs_template_id")
  type           String   // MATERIAL, LABOR, EQUIPMENT
  name           String
  description    String?  @db.Text
  unit           String
  quantity       Decimal  @db.Decimal(15, 4)
  estimatedCost  Decimal  @map("estimated_cost") @db.Decimal(15, 2)
  supplierName   String?  @map("supplier_name")
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  wbsTemplate WbsTemplate @relation(fields: [wbsTemplateId], references: [id], onDelete: Cascade)

  @@index([wbsTemplateId])
  @@map("budget_resource_templates")
  @@schema("public")
}
